<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>프로필 수정</title>

  <!-- CSRF (비활성이어도 에러 안 나게 null-safe) -->
  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">

<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-lg font-bold">✏️ 프로필 수정</h2>
    <a href="/user/profile" class="text-sm text-gray-500 hover:underline">내 프로필 보기</a>
  </div>

  <!-- user 모델이 없으면 안내 -->
  <div th:if="${user == null}" class="text-sm text-red-600">
    사용자 정보를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.
  </div>

  <!-- ✅ user 가 있을 때만 폼 렌더링 -->
  <div th:if="${user != null}"
       th:with="imgUrl=${!#strings.isEmpty(user.profileImage) ? user.profileImage : '/img/default.png'}">

    <!-- enctype 꼭 필요 -->
    <form th:action="@{/user/edit}" method="post" enctype="multipart/form-data" th:object="${user}" class="space-y-4">
      <!-- CSRF hidden (null-safe) -->
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>

      <!-- 자기소개 -->
      <div>
        <label class="block text-sm font-medium text-gray-700">자기소개</label>
        <textarea th:field="*{bio}" rows="4"
                  class="w-full mt-1 border rounded px-3 py-2 text-sm"
                  placeholder="간단한 소개를 적어주세요."></textarea>
      </div>

      <!-- 현재 이미지 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">현재 프로필 이미지</label>
        <img id="currentPreview"
             th:src="${imgUrl}"
             alt="프로필 이미지"
             class="w-20 h-20 rounded-full object-cover border shadow"/>
      </div>

      <!-- 이미지 업로드 -->
      <div>
        <label for="imageFile" class="block text-sm font-medium text-gray-700">새 이미지 업로드</label>
        <input id="imageFile" type="file" name="imageFile"
               class="w-full mt-1 text-sm border rounded px-3 py-2"
               accept="image/*">
        <p class="text-xs text-gray-500 mt-1">JPG/PNG 권장, 최대 5MB</p>

        <!-- 선택 시 미리보기 -->
        <div class="mt-3" id="newPreviewWrap" style="display:none;">
          <span class="text-xs text-gray-500">미리보기</span>
          <img id="newPreview" src="" class="w-20 h-20 rounded-full object-cover border shadow mt-1"/>
        </div>
      </div>

      <!-- 버튼 -->
      <div class="flex items-center justify-end gap-2 pt-2">
        <a href="/user/profile" class="px-4 py-2 text-sm rounded border hover:bg-gray-50">취소</a>
        <button type="submit"
                class="bg-blue-600 text-white text-sm px-4 py-2 rounded hover:bg-blue-700">
          저장
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 미리보기 스크립트 -->
<script>
  const input = document.getElementById('imageFile');
  const wrap  = document.getElementById('newPreviewWrap');
  const img   = document.getElementById('newPreview');

  if (input) {
    input.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) { wrap.style.display = 'none'; img.src = ''; return; }
      const reader = new FileReader();
      reader.onload = () => { img.src = reader.result; wrap.style.display = 'block'; };
      reader.readAsDataURL(file);
    });
  }
</script>

</body>
</html>
