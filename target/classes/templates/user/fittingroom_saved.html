<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>저장된 피팅룸 코디 세트 목록</title>

  <meta name="_csrf" th:if="${_csrf}" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:if="${_csrf}" th:content="${_csrf.headerName}" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    .thumb {
      aspect-ratio: 3/5;
      background: #f8f8f8;
      border-radius: 1rem;
      overflow: hidden;
      position: relative;
    }
    .thumb img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 미니 아바타 썸네일 스테이지 */
    .mini-stage {
      position: relative;
      width: 100%;
      aspect-ratio: 3/5;
      background: #f7f7f7;
      border-radius: 1rem;
      overflow: hidden;
      /* 본 화면과 동일한 기준점 변수 */
      /* 미리보기와 동일한 기준점 */
      --topY: 42%;
      --outerY: 42%;
      --bottomY: 66%;
      --shoesY: 88%;
      --topW: 60%;
      --outerW: 62%;
      --bottomW: 55%;
      --shoesW: 40%;
    }
    .mini-stage svg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }
    .mini-slot {
      position: absolute;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .mini-slot img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      font-size: 0;
    }
    .mini-slot img:not([src]),
    .mini-slot img[src=""] {
      opacity: 0;
      pointer-events: none;
    }
    .mini-slot.face {
      top: 14%;
      width: 26%;
      height: 26%;
      border-radius: 50%;
      overflow: hidden;
    }

    /* 메인 피팅룸 기본값 및 슬롯 위치/크기 조정 */
    /* 목록 썸네일: 피팅룸 기본 위치에 더 가깝게 조정 */
    /* 메인 피팅룸 위치에 맞춰 재조정 */
    .mini-slot.top    { top: var(--topY);   width: var(--topW);   transform: translate(-50%, -50%); }
    .mini-slot.outer  { top: var(--outerY); width: var(--outerW); transform: translate(-50%, -50%); }
    .mini-slot.bottom { top: var(--bottomY); width: var(--bottomW); max-width: 65%; max-height: 55%; transform: translate(-50%, -50%); }
    .mini-slot.shoes  { top: var(--shoesY); width: var(--shoesW); transform: translate(-50%, -50%); }
    .mini-slot.accessory { top: 30%; width: 30%; }
  </style>
  <style>
    /* 미리보기 모달용 슬롯 (메인과 동일한 위치/크기) */
    .preview-stage {
      position: relative;
      width: 320px;
      aspect-ratio: 3/5;
      background: #f7f7f7;
      border-radius: 1rem;
      overflow: hidden;
      /* 본 화면과 동일한 기준점 변수 */
      --topY: 42%;
      --outerY: 42%;
      --bottomY: 66%;
      --shoesY: 88%;
      --topW: 60%;
      --outerW: 62%;
      --bottomW: 55%;
      --shoesW: 40%;
    }
    .preview-slot {
      position: absolute;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .preview-slot img {
      width: 100%;
      height: auto;
      display: block;
      object-fit: contain;
      font-size: 0;
    }
    .preview-slot img:not([src]),
    .preview-slot img[src=""] {
      opacity: 0;
      pointer-events: none;
    }
    .preview-slot.face {
      top: 14%;
      width: 26%;
      height: 26%;
      border-radius: 50%;
      overflow: hidden;
    }
    .preview-slot.top    { top: var(--topY);   width: var(--topW);   transform: translate(-50%, -50%); }
    .preview-slot.outer  { top: var(--outerY); width: var(--outerW); transform: translate(-50%, -50%); }
    .preview-slot.bottom { top: var(--bottomY); width: var(--bottomW); max-width: 65%; max-height: 55%; transform: translate(-50%, -50%); }
    .preview-slot.shoes  { top: var(--shoesY); width: var(--shoesW); transform: translate(-50%, -50%); }
    .preview-slot.accessory { top: 30%; width: 30%; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white border-b mb-8">
  <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">나의 피팅룸 코디 세트 목록</h1>
    <a th:href="@{'/user/profile/' + ${me.id} + '/fittingroom'}"
       class="px-3 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
      피팅룸으로 돌아가기
    </a>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 space-y-6">

  <div th:if="${#lists.isEmpty(sets)}"
       class="text-center text-gray-500 py-16 text-lg">
    아직 저장된 코디 세트가 없습니다 😊<br/>
    <a th:href="@{'/user/profile/' + ${me.id} + '/fittingroom'}"
       class="text-blue-600 hover:underline text-sm">
      피팅룸으로 이동해서 코디를 저장해 보세요
    </a>
  </div>

  <div th:if="${!#lists.isEmpty(sets)}"
       class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
    <div th:each="s : ${sets}"
         class="bg-white rounded-xl shadow p-4 space-y-3 flex flex-col justify-between">

      <div class="thumb relative">
        <div class="mini-stage">
          <!-- 기본 아바타 실루엣 -->
          <svg viewBox="0 0 300 500" aria-hidden="true">
            <rect x="0" y="0" width="300" height="500" fill="#f7f7f7" rx="20"></rect>
            <g transform="translate(150,260)" fill="#e6cbb3">
              <ellipse cx="0" cy="0" rx="60" ry="95"></ellipse>
              <rect x="-75" y="-90" width="150" height="30" rx="15"></rect>
              <ellipse cx="-90" cy="-40" rx="22" ry="60"></ellipse>
              <ellipse cx="90"  cy="-40" rx="22" ry="60"></ellipse>
              <ellipse cx="-25" cy="120" rx="28" ry="95"></ellipse>
              <ellipse cx="25"  cy="120" rx="28" ry="95"></ellipse>
            </g>
            <g transform="translate(150,110)" fill="#e6cbb3">
              <circle cx="0" cy="0" r="45"></circle>
            </g>
            <g transform="translate(150,470)" fill="#cfcfcf">
              <ellipse cx="-30" cy="0" rx="28" ry="12"></ellipse>
              <ellipse cx="30" cy="0" rx="28" ry="12"></ellipse>
            </g>
          </svg>
          <div class="mini-slot face">
            <img th:src="${s.faceImage}" alt="face" />
          </div>

          <!-- 코디 레이어 -->
          <div class="mini-slot top">
            <img th:src="${s.topImage}" alt="top" />
          </div>
          <div class="mini-slot outer">
            <img th:src="${s.outerImage}" alt="outer" />
          </div>
          <div class="mini-slot bottom">
            <img th:src="${s.bottomImage}" alt="bottom" />
          </div>
          <div class="mini-slot shoes">
            <img th:src="${s.shoesImage}" alt="shoes" />
          </div>
          <div class="mini-slot accessory">
            <img th:src="${s.accessoryImage}" alt="accessory" />
          </div>
        </div>
      </div>

      <div>
        <h2 class="font-semibold text-gray-800 truncate" th:text="${s.name}">My Outfit</h2>
        <p class="text-xs text-gray-500"
           th:text="${#temporals.format(s.createdAt, 'yyyy-MM-dd HH:mm')}">
          2025-10-28
        </p>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button class="px-2 py-1 text-sm bg-gray-200 hover:bg-gray-300 rounded"
                th:attr="onclick='previewSet(' + ${s.id} + ')'">
          코디 미리보기
        </button>
        <button class="px-2 py-1 text-sm bg-red-500 text-white hover:bg-red-600 rounded"
                th:attr="onclick='deleteSet(' + ${s.id} + ')'">
          세트 삭제
        </button>
      </div>
    </div>
  </div>
</main>

<!-- 코디 미리보기 모달 -->
<div id="previewModal"
     class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center z-50"
     onclick="closePreview()">
  <div class="relative bg-white p-4 rounded-xl shadow-xl max-w-xl w-full flex flex-col items-center"
       onclick="event.stopPropagation()">
    <div id="preview-stage" class="preview-stage">
      <!-- 기본 아바타 실루엣 -->
      <svg viewBox="0 0 300 500" aria-hidden="true" style="position:absolute; inset:0; width:100%; height:100%;">
        <rect x="0" y="0" width="300" height="500" fill="#f7f7f7" rx="20"></rect>
        <g transform="translate(150,260)" fill="#e6cbb3">
          <ellipse cx="0" cy="0" rx="60" ry="95"></ellipse>
          <rect x="-75" y="-90" width="150" height="30" rx="15"></rect>
          <ellipse cx="-90" cy="-40" rx="22" ry="60"></ellipse>
          <ellipse cx="90"  cy="-40" rx="22" ry="60"></ellipse>
          <ellipse cx="-25" cy="120" rx="28" ry="95"></ellipse>
          <ellipse cx="25"  cy="120" rx="28" ry="95"></ellipse>
        </g>
        <g transform="translate(150,110)" fill="#e6cbb3">
          <circle cx="0" cy="0" r="45"></circle>
        </g>
        <g transform="translate(150,470)" fill="#cfcfcf">
          <ellipse cx="-30" cy="0" rx="28" ry="12"></ellipse>
          <ellipse cx="30" cy="0" rx="28" ry="12"></ellipse>
        </g>
      </svg>
      <div class="preview-slot face">
        <img id="prev-face" alt="face" />
      </div>
      <div class="preview-slot top">
        <img id="prev-top" alt="top" />
      </div>
      <div class="preview-slot bottom">
        <img id="prev-bottom" alt="bottom" />
      </div>
      <div class="preview-slot outer">
        <img id="prev-outer" alt="outer" />
      </div>
      <div class="preview-slot shoes">
        <img id="prev-shoes" alt="shoes" />
      </div>
      <div class="preview-slot accessory">
        <img id="prev-accessory" alt="accessory" />
      </div>
    </div>
    <div class="text-center mt-4">
      <button class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded"
              onclick="closePreview()">
        닫기
      </button>
      <button class="px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700 rounded ml-2"
              id="btn-open-in-fittingroom">
        피팅룸에서 열기
      </button>
      <button class="px-4 py-2 bg-indigo-600 text-white hover:bg-indigo-700 rounded ml-2"
              onclick="downloadPreview()">
        이미지 저장
      </button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
  const userId = /*[[${me.id}]]*/ '0';

  let currentPreviewSetId = null;

  function closePreview() {
    document.getElementById("previewModal").classList.add("hidden");
  }

  // 코디 미리보기
  async function previewSet(id) {
    try {
      const r = await fetch(`/user/profile/${userId}/fittingroom/api/${id}`);
      if (!r.ok) throw new Error(`status ${r.status}`);
      const s = await r.json();

      currentPreviewSetId = id;
      document.getElementById("previewModal").classList.remove("hidden");
      const faceEl = document.getElementById("prev-face");
      if (faceEl) faceEl.src = s.faceImage || "";
      ["top","bottom","outer","shoes","accessory"].forEach(k=>{
        const img = document.getElementById("prev-"+k);
        if (img) img.src = s[k+"Image"] || "";
      });
    } catch (e) {
      console.error("[previewSet] 실패", e);
      alert("미리보기를 불러오지 못했습니다.");
    }
  }

  // 캡처 다운로드
  function downloadPreview() {
    const stage = document.getElementById("preview-stage");
    if (!stage) return;

    html2canvas(stage).then(canvas => {
      const link = document.createElement("a");
      link.download = "fittingroom_saved.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  }

  // 피팅룸에서 열기
  document.getElementById("btn-open-in-fittingroom")
    ?.addEventListener("click", () => {
      if (!currentPreviewSetId) return;
      window.location.href =
        `/user/profile/${userId}/fittingroom?setId=${currentPreviewSetId}`;
    });
</script>
</body>
</html>
