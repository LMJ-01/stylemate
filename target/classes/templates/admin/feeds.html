<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>관리자 - 피드/댓글 관리</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:0; }
    .wrap { max-width: 1100px; margin: 32px auto; background: #fff; padding: 20px 22px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    h1 { margin: 0 0 16px; }
    .toolbar { display:flex; gap:10px; align-items:center; margin-bottom:14px; }
    select, button, textarea { padding:8px 10px; border-radius:6px; border:1px solid #d7d7d7; font-size:14px; }
    button { background:#2563eb; color:#fff; border:none; cursor:pointer; }
    button.secondary { background:#e5e7eb; color:#111; }
    .feed-card { border:1px solid #eee; border-radius:10px; padding:12px; margin-bottom:12px; background:#fafafa; }
    .muted { color:#666; font-size:12px; }
    .badge { display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; background:#e0e7ff; color:#1d4ed8; }
    .comments { margin-top:8px; padding-left:12px; border-left:2px solid #eee; }
    .comment-row { margin-bottom:6px; }
    textarea { width:100%; min-height:60px; }
    .images { display:flex; gap:8px; margin:6px 0; flex-wrap:wrap; }
    .images img { width:120px; height:120px; object-fit:cover; border:1px solid #e5e5e5; border-radius:8px; background:#fff; }
    .section-title { font-weight:600; margin:6px 0 4px; }
  </style>
</head>
<body>
    <div class="wrap">
      <h1>피드/댓글 관리</h1>
      <div class="toolbar">
        <label>정렬
          <select id="order" onchange="loadFeeds()">
          <option value="latest">최신순</option>
          <option value="id">ID순</option>
        </select>
      </label>
      <a href="/admin" style="margin-left:auto; text-decoration:none;">
        <button class="secondary">← 대시보드</button>
      </a>
    </div>

    <div id="feed-list"></div>
  </div>

  <script>
    async function loadFeeds() {
      const order = document.getElementById('order').value;
      const res = await fetch(`/admin/feeds/api?order=${order}`);
      const data = await res.json();
      const list = document.getElementById('feed-list');
      list.innerHTML = '';
      data.forEach(f => {
        const card = document.createElement('div');
        card.className = 'feed-card';
        card.innerHTML = `
          <div><strong>ID #${f.id}</strong> · <span class="muted">${f.createdAt || ''}</span> · <span class="muted">${f.userEmail || ''}</span> ${f.hidden ? '<span class="badge">숨김</span>' : ''}</div>
          <div style="margin:6px 0;">${f.content || ''}</div>
          <div class="images">
            ${renderImg(f.imageUrl)}
            ${renderImg(f.imageUrlB)}
          </div>
          <div style="margin-top:6px;">
            <button style="background:#ef4444;" onclick="deleteFeed(${f.id})">삭제</button>
          </div>
          <div style="margin-top:8px;">
            <textarea id="memo-${f.id}" placeholder="관리자 메모">${f.adminMemo || ''}</textarea>
            <button onclick="saveMemo(${f.id})">메모 저장</button>
          </div>
          <div class="section-title">댓글 (${f.comments.length})</div>
          <div class="comments">
            ${f.comments.map(c => `
              <div class="comment-row">
                <strong>#${c.id}</strong> <span class="muted">${c.createdAt || ''} · ${c.userEmail || ''}</span> ${c.hidden ? '<span class="badge">숨김</span>' : ''}
                <div>${c.content || ''}</div>
                <div style="margin-top:4px;">
                  <button style="background:#ef4444;" onclick="deleteComment(${c.id})">삭제</button>
                </div>
                <div style="margin-top:4px;">
                  <textarea id="cmemo-${c.id}" placeholder="관리자 메모">${c.adminMemo || ''}</textarea>
                  <button onclick="saveCommentMemo(${c.id})">메모 저장</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function saveMemo(id) {
      const memo = document.getElementById('memo-' + id)?.value || '';
      try {
        const res = await fetch(`/admin/feeds/api/${id}/hide`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hidden: false, adminMemo: memo })
        });
        if (!res.ok) throw new Error(res.status);
        loadFeeds();
      } catch (e) {
        alert('메모 저장 실패: ' + e);
      }
    }

    async function saveCommentMemo(id) {
      const memo = document.getElementById('cmemo-' + id)?.value || '';
      try {
        const res = await fetch(`/admin/feeds/api/comment/${id}/hide`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hidden: false, adminMemo: memo })
        });
        if (!res.ok) throw new Error(res.status);
        loadFeeds();
      } catch (e) {
        alert('댓글 메모 저장 실패: ' + e);
      }
    }

    async function deleteFeed(id) {
      if (!confirm('피드를 삭제할까요?')) return;
      try {
        const res = await fetch(`/admin/feeds/api/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(res.status);
        loadFeeds();
      } catch (e) {
        alert('피드 삭제 실패: ' + e);
      }
    }

    async function deleteComment(id) {
      if (!confirm('댓글을 삭제할까요?')) return;
      try {
        const res = await fetch(`/admin/feeds/api/comment/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error(res.status);
        loadFeeds();
      } catch (e) {
        alert('댓글 삭제 실패: ' + e);
      }
    }

    function renderImg(url) {
      if (!url) return '';
      const safe = url;
      return `<img src="${safe}" alt="image" onerror="this.style.display='none';" />`;
    }

    document.addEventListener('DOMContentLoaded', loadFeeds);
  </script>
</body>
</html>
