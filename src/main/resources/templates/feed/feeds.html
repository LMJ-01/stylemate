<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전체 피드</title>

  <!-- ✅ null-safe CSRF 메타 -->
  <meta name="_csrf" th:content="${_csrf?.token}"/>
  <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

  <!-- ✅ Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 이미 있던 모달/댓글 스크립트 -->
  <script defer src="/js/modal.js?v=2"></script>

  <!-- ✅ 투표/카운트다운 스크립트 추가 -->
  <script defer src="/js/vote.js?v=2"></script>	
</head>

<body class="bg-gray-50 min-h-screen p-6">
<nav class="flex justify-between items-center mb-8">
  <h1 class="text-2xl font-bold text-gray-800">📷 스타일메이트</h1>
  <div class="space-x-4">
    <a href="/home" class="text-gray-600 hover:text-black">🏠 홈</a>
    <a href="/feed/list" class="text-gray-600 hover:text-black">📰 전체 피드</a>

    <!-- ✅ 내 프로필 -->
    <a th:href="@{/user/profile/{id}(id=${loginUserId})}" class="text-gray-600 hover:text-black">👤 내 프로필</a>

    <!-- ✅ 로그아웃 -->
    <form th:action="@{/logout}" method="post" class="inline">
      <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
      <button type="submit" class="text-gray-600 hover:text-black">🚪 로그아웃</button>
    </form>
  </div>
</nav>

<section class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow">
  <!-- 상단 정렬/검색 -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
    <div class="space-x-2 text-sm">
      <a href="/feed/list?sort=recent" class="text-gray-700 hover:underline">🕒 최신순</a>
      <a href="/feed/list?sort=old" class="text-gray-700 hover:underline">⏳ 오래된순</a>
      <a href="/feed/list?sort=likes" class="text-gray-700 hover:underline">❤️ 좋아요순</a>
      <a href="/feed/list?sort=comments" class="text-gray-700 hover:underline">💬 댓글순</a>
    </div>

    <form method="get" action="/feed/list" class="flex items-center gap-2">
      <input type="text" name="tag" placeholder="해시태그 검색"
             class="border rounded px-2 py-1 text-sm" th:value="${param.tag}">
      <button type="submit" class="bg-gray-800 text-white text-sm px-3 py-1 rounded hover:bg-black">검색</button>
    </form>

    <div class="text-right">
      <a href="/feed/new" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm shadow">
        ✏️ 피드 작성하기
      </a>
    </div>
  </div>

  <!-- 특정 유저 피드 -->
  <div th:if="${viewingUserId != null}" class="mb-6">
    <h2 class="text-lg font-semibold">
      <span th:if="${!#lists.isEmpty(feeds) and feeds[0].user != null}"
            th:text="${feeds[0].user.nickname}">사용자</span>님의 피드 목록
    </h2>
  </div>

  <!-- 피드 없음 -->
  <div th:if="${#lists.isEmpty(feeds)}" class="text-center text-gray-500 py-10">
    <p class="text-lg font-semibold mb-3">등록된 피드가 없습니다.</p>
    <a th:if="${loginUserId != null and loginUserId == viewingUserId}" href="/feed/new"
       class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm shadow">
      ✏️ 피드 작성하러 가기
    </a>
  </div>

  <!-- ✅ 피드 목록 -->
  <div th:each="feed : ${feeds}" class="mb-8 border-b pb-6">
    <div class="flex justify-between items-center mb-2">
      <a th:if="${feed.user != null}"
         th:href="@{/user/profile/{userId}(userId=${feed.user.id})}"
         class="text-sm font-semibold text-blue-600 hover:underline"
         th:text="${feed.user.nickname}">작성자</a>
      <span th:if="${feed.user == null}" class="text-sm text-gray-500">알 수 없음</span>
      <span class="text-xs text-gray-400" th:text="${feed.formattedDate ?: ''}">작성일</span>
    </div>

    <!-- ✅ 일반 피드 -->
    <div th:if="${!feed.vote and feed.imageUrl != null}" class="mb-3">
      <img th:src="${feed.imageUrl}" alt="피드 이미지"
           class="rounded-lg w-full max-h-[500px] object-contain shadow-sm mx-auto"
           loading="lazy" decoding="async" />
    </div>

    <!-- ✅ 투표 피드 -->
    <div th:if="${feed.vote}" class="mb-3">
      <div th:replace="~{fragments/vote :: voteBox(feed=${feed})}"></div>
    </div>

    <!-- ✅ 피드 내용 -->
    <p class="text-gray-800 text-sm mb-2" th:text="${feed.content ?: ''}">피드 내용</p>

    <!-- ✅ 태그 -->
    <div th:if="${feed.tagList != null and !#lists.isEmpty(feed.tagList)}" class="mb-2">
      <span th:each="tag : ${feed.tagList}" th:text="${tag}" class="text-blue-500 text-xs mr-2">#태그</span>
    </div>

    <!-- ✅ 좋아요 / 댓글 -->
    <div class="text-xs text-gray-500 flex items-center space-x-4 mt-2">
      <button type="button"
              th:id="|like-btn-${feed.id}|"
              th:onclick="|likeFeed(${feed.id})|"
              class="hover:text-red-600 transition">
        ❤️ <span th:id="|like-count-${feed.id}|" th:text="${feed.likeCount ?: 0}">0</span>
      </button>

      <button type="button"
              th:onclick="'openCommentModal(' + ${feed.id} + ')'"
              class="hover:text-blue-600 transition">
        💬 <span th:id="|comment-count-${feed.id}|" th:text="${feed.commentCount ?: 0}">0</span>
      </button>
    </div>

    <!-- ✅ 수정/삭제 -->
    <div th:if="${loginUserId != null and feed.user != null and loginUserId == feed.user.id}"
         class="mt-2 space-x-2">
      <a th:href="@{/feed/edit/{id}(id=${feed.id})}" class="text-blue-500 text-sm hover:underline">수정</a>
      <form th:action="@{/feed/delete/{id}(id=${feed.id})}" method="post" style="display:inline;">
        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}"/>
        <button type="submit" class="text-red-500 text-sm hover:underline"
                onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
      </form>
    </div>
  </div>
</section>

<!-- ✅ 댓글 모달 -->
<div id="commentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
  <div id="modal-wrapper"
       th:attr="data-user-id=${loginUserId}"
       class="bg-white rounded-2xl w-[95%] max-w-6xl shadow-2xl overflow-auto max-h-[95vh] relative">
    <button onclick="closeCommentModal()" class="absolute top-3 right-3 text-gray-500 hover:text-black text-xl">✕</button>
    <div id="commentModalContent" class="p-6 md:p-8"></div>
  </div>
</div>

<!-- ✅ 모달 관련 스크립트 -->
<script>
  function openCommentModal(feedId) {
    fetch(`/feed/modal/${feedId}`, { credentials: 'same-origin' })
      .then(res => res.text())
      .then(html => {
        document.getElementById('commentModalContent').innerHTML = html;
        document.getElementById('commentModal').classList.remove('hidden');
        registerModalEvents(feedId);
      })
      .catch(() => alert('댓글 모달 로드 실패'));
  }

  function closeCommentModal() {
    document.getElementById('commentModal').classList.add('hidden');
  }
</script>
</body>
</html>
